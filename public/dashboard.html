<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="manifest" href="manifest.json" />
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>DB Digital Dashboard</title>
	<link rel="stylesheet" href="./css/common.css?v=20240930">

	<!-- update the version number as needed -->
	<script defer src="/__/firebase/10.12.2/firebase-app-compat.js"></script>
	<!-- include only the Firebase features as you need -->
	<script defer src="/__/firebase/10.12.2/firebase-auth-compat.js"></script>
	<script defer src="/__/firebase/10.12.2/firebase-database-compat.js"></script>
	<script defer src="/__/firebase/10.12.2/firebase-analytics-compat.js"></script>
	<script defer src="/__/firebase/10.12.2/firebase-messaging-compat.js"></script>

	<!-- 
  initialize the SDK after all desired features are loaded, set useEmulator to false
  to avoid connecting the SDK to running emulators.
-->
	<script defer src="/__/firebase/init.js?useEmulator=true"></script>

		<style>
			/* ëª¨ë‹¬ ìˆ¨ê¹€ ì„¤ì • */
			.modal {
				display: none; /* ì´ˆê¸° ìƒíƒœì—ì„œ ë³´ì´ì§€ ì•Šë„ë¡ ì„¤ì • */
				position: fixed;
				z-index: 1000;
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
				background-color: rgba(0, 0, 0, 0.5);
				justify-content: center;
				align-items: center;
			}

			.modal-content {
				background-color: #fff;
				padding: 20px;
				border-radius: 10px;
				width: 300px;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			}

			.form-group {
				display: flex;
				flex-direction: column;
				gap: 10px;
				margin-bottom: 20px;
			}

			.form-group label {
				display: flex; /* í”Œë ‰ìŠ¤ë°•ìŠ¤ë¡œ ì •ë ¬ */
				align-items: center; /* ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ */
				gap: 8px; /* ì²´í¬ë°•ìŠ¤ì™€ í…ìŠ¤íŠ¸ ì‚¬ì´ì˜ ê°„ê²© */
				font-size: 1.4rem; /* í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì • */
				color: #333; /* í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
			}

			.btn-submit {
				padding: 10px;
				background-color: #00854a;
				color: white;
				border: none;
				border-radius: 5px;
				cursor: pointer;
			}

			.btn-submit:hover {
				background-color: #005f37;
			}

			.modal-subject {
				text-align: center; 
				font-size: 1.8rem; 
				font-weight: 700; 
				margin-bottom: 1.5rem; 
				color: #333; 
			}

			input[type="checkbox"] {
				display: inline-block;
				width: 16px;
				height: 16px;
				margin: 0;
				clip: auto;
				opacity: 1;
				appearance: none;
				position: relative;
				border: 2px solid #d3d3d3;
				border-radius: 4px;
				}

				input[type="checkbox"]:checked {
				background-color: #00854a;
				border-color: #00854a;
				}

				input[type="checkbox"]:checked::after {
				content: "";
				position: absolute;
				top: 40%;
				left: 50%;
				width: 4px; /* ì²´í¬ í‘œì‹œì˜ ë„ˆë¹„ */
				height: 8px; /* ì²´í¬ í‘œì‹œì˜ ë†’ì´ */
				border: solid #fff;
				border-width: 0 2px 2px 0;
				transform: translate(-50%, -50%) rotate(45deg);
				}
			
		</style>

</head>

<body>
	<div id="wrap">
		<!-- header -->
		<header>
			<form id="frm" action="#">
				<!-- ë¡œê·¸ì¸ -->
				<div class="user_info">
					<h1 id="title">DB Digital Dashboard</h1>
					<div class="user">
						<div id="displayName" class="name"></div>
						<div class="part">
							<span id="displayPos"></span>
							<span id="displayDept"></span>
							<input type="hidden" id="name"></input>
							<input type="hidden" id="email"></input>
							<input type="hidden" id="uid"></input>
						</div>
					</div>
					<button id="logout" class="btn_logout" type="button">ë¡œê·¸ì•„ì›ƒ</button>
					<button id="setpush" class="btn_logout" style="top:6rem;" type="button">ì•Œë¦¼ ë“±ë¡</button>
				</div>
				<!-- //ë¡œê·¸ì¸ -->

					<!-- ëª¨ë‹¬ -->
					<div id="notificationModal" class="modal">
						<div class="modal-content">
							<h2 class="modal-subject">ì•Œë¦¼ ë“±ë¡</h2>
							<form id="notificationForm">
								<div class="form-group">
									<label>
										<input type="checkbox" name="department" value="1000">
										ì†ë³´
									</label>
									<label>
										<input type="checkbox" name="department" value="2000">
										ìƒëª…
									</label>
									<label>
										<input type="checkbox" name="department" value="3000">
										ê¸ˆíˆ¬
									</label>
									<label>
										<input type="checkbox" name="department" value="5000">
										ì €ì¶•
									</label>
									<label>
										<input type="checkbox" name="department" value="4000">
										í•˜ì´í…
									</label>
								</div>
								<button type="button" class="btn-submit" onclick="requestPermission()">ë“±ë¡ ì‹ ì²­</button>
								<button type="button" class="btn-submit" onclick="closeModal()">ë‹«ê¸°</button>
							</form>
						</div>
					</div>
					<!-- ëª¨ë‹¬ -->

				<!-- ìƒíƒœ -->
				<div id="statBox" class="stat-box">
					<!-- ì‹ í˜¸ -->
					<div id="summaryStat" class="summary-stat">
						<ul>
							<li id="n1000">
								<span>ì†ë³´</span>
								<object id="1000" aria-hidden="true" type="image/svg+xml"
									data="./images/img_stat_green.svg"></object>
							</li>
							<li id="n2000">
								<span>ìƒëª…</span>
								<object id="2000" aria-hidden="true" type="image/svg+xml"
									data="./images/img_stat_red.svg"></object>
							</li>
							<li id="n3000">
								<span>ê¸ˆíˆ¬</span>
								<object id="3000" aria-hidden="true" type="image/svg+xml"
									data="./images/img_stat_yellow.svg"></object>
							</li>
							<li id="n5000">
								<span>ì €ì¶•</span>
								<object id="5000" aria-hidden="true" type="image/svg+xml"
									data="./images/img_stat_green.svg"></object>
							</li>
							<li id="n4000">
								<span>í•˜ì´í…</span>
								<object id="4000" aria-hidden="true" type="image/svg+xml"
									data="./images/img_stat_gray.svg"></object>
							</li>
						</ul>
						<div class="btn-box">
							<button class="btn-add" type="button" onclick="openAddStat();">ë³´ê³ ë‚´ìš© ì…ë ¥</button>
							<button class="btn-add" type="button" onclick="moveSendMail();">ì´ë©”ì¼ ë³´ë‚´ê¸°</button>
						</div>
					</div>
					<!-- //ì‹ í˜¸ -->

					<!-- ì…ë ¥ -->
					<div class="add-stat">
						<div class="select-box">
							<select id="dept" name="dept" class="stat">
								<option value="0000">-ì„ íƒ-</option>
								<option value="1000">ì†ë³´</option>
								<option value="2000">ìƒëª…</option>
								<option value="3000">ê¸ˆíˆ¬</option>
								<option value="5000">ì €ì¶•</option>
								<option value="4000">í•˜ì´í…</option>
							</select>
							<select id="stat" name="stat" class="stat">
								<option value="none">-ì„ íƒ-</option>
								<option value="green">ì´ˆë¡</option>
								<option value="yellow">ë…¸ë‘</option>
								<option value="red">ë¹¨ê°•</option>
								<option value="gray">íšŒìƒ‰</option>
							</select>
								<label class="label">
									<input type="checkbox" class="isPush" id="isPush">
									ì•Œë¦¼ì—¬ë¶€
									<span class="tooltip">
										<img src="./icons/info_icons.png?v=20240930" alt="info">
										<span class="tooltip-text">í•´ë‹¹ ë¶€ì„œë¥¼ ì•Œë¦¼ ë“±ë¡í•œ ê¸°ê¸°ë¡œ ì œëª©ì´ ì•Œë¦¼ ì „ì†¡ë©ë‹ˆë‹¤. </span>
									</span>
								</label>
							</div>
							<div class="form-group">
								<!-- <label for="subject">ì œëª©</label> -->
								<input type="text" id="subject" name="subject" class="input-title" placeholder="ì œëª©">
						</div>
						<div class="textarea">
								<textarea id="msg" placeholder="ë‚´ìš©"></textarea>
						</div>
						<button id="submit" class="btn-submit" type="button">í™•ì¸</button>
						<button class="btn-submit" type="button" onclick="closeAddStat();">ë‹«ê¸°</button>
					</div>
					<!-- //ì…ë ¥ -->
				</div>
				<!-- ìƒíƒœ -->
			</form>
		</header>
		<!-- //header -->
		<!-- main -->
		<main id="container" class="container">
			<!-- ë¦¬ìŠ¤íŠ¸ -->
			<div class="list_msg">
				<ul id="stats">
				</ul>
			</div>
			<!-- //ë¦¬ìŠ¤íŠ¸ -->
		</main>
		<!-- main -->
	</div>
	<script>
		//ì¸íŠ¸ë¡œ ì• ë‹ˆë©”ì´ì…˜
		window.addEventListener("load", function () {
			document.getElementById("summaryStat").classList.add("on");
		});

		//ì…ë ¥ì°½ ì—´ê¸°
		function openAddStat() {
			document.getElementById("statBox").classList.add("on");
		}
		//ì…ë ¥ì°½ ë‹«ê¸°
		function closeAddStat() {
			document.getElementById("statBox").classList.remove("on");
		}

		function moveSendMail() {
			window.location.href = 'mail.html';
		}
	</script>

		<script>
			if ('serviceWorker' in navigator) {
				navigator.serviceWorker.register('/firebase-messaging-sw.js')
					.then(function (registration) {
						console.log('Service Worker registered with scope:', registration.scope);
					}).catch(function (error) {
						console.error('Service Worker registration failed:', error);
					});
			}
		</script>

		<script>
			var deptCheckedCount = 0;
			function pushDeptsCheck() {
				// í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ UID ê°€ì ¸ì˜¤ê¸°
				const uid = document.getElementById('uid').value;
				// ê° ë¶€ì„œì˜ ì²´í¬ë°•ìŠ¤ë¥¼ ì„ íƒ
				const departments = document.querySelectorAll('input[name="department"]');
				// ë¶€ì„œë³„ë¡œ ì²´í¬ë°•ìŠ¤ì˜ ìƒíƒœë¥¼ ì„¤ì •
				departments.forEach(dept => {
					const deptId = dept.value; // ë¶€ì„œ ID
					// Firebase DBì—ì„œ í•´ë‹¹ ë¶€ì„œì— UIDê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
					firebase.database().ref(`noti/${deptId}/${uid}`).get().then(snapshot => {
						if (snapshot.exists()) {
							// UIDê°€ ì¡´ì¬í•˜ë©´ ì²´í¬ë°•ìŠ¤ë¥¼ ì²´í¬ ìƒíƒœë¡œ ì„¤ì •
							dept.checked = true;
							hasChecked = true;
						} else {
							// UIDê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ì²´í¬ë°•ìŠ¤ë¥¼ ì²´í¬ í•´ì œ
							dept.checked = false;
							deptCheckedCount++;
							if (deptCheckedCount == departments.length){
								//ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€ì™€ ëª¨ë‹¬ í‘œì‹œ
								if (!("Notification" in window)) {
									alert('ì•Œë¦¼ì´ ë“±ë¡ëœ ë¶€ì„œê°€ ì—†ìŠµë‹ˆë‹¤. iOSì˜ ê²½ìš°, í™ˆ í™”ë©´ì— ì¶”ê°€ í›„ ì•Œë¦¼ ë“±ë¡ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
								} else {
									alert('ì•Œë¦¼ì´ ë“±ë¡ëœ ë¶€ì„œê°€ ì—†ìŠµë‹ˆë‹¤. ì•Œë¦¼ì„ ë°›ìœ¼ë ¤ë©´ ì•Œë¦¼ ë“±ë¡ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë“±ë¡ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.');
								}
							}
						}
					}).catch(error => {
						console.error('pushDeptsCheck Error:', error);
					});
				});
			}

			function openModal() {
				document.getElementById('notificationModal').style.display = 'flex';
			}

			// ëª¨ë‹¬ ë‹«ê¸°
			function closeModal() {
				document.getElementById('notificationModal').style.display = 'none';
			}

			// ì•Œë¦¼ ë“±ë¡ ë²„íŠ¼ì— ëª¨ë‹¬ ì—´ê¸° ì´ë²¤íŠ¸ ì¶”ê°€
			document.getElementById('setpush').addEventListener('click', openModal);
		</script>


	<script>
		var needsRegisterWithToken = null;
		document.addEventListener('DOMContentLoaded', function () {

			const emailVaildRegExp = /.*.db(fis|inc|group).co.kr$/i;
			firebase.auth().onAuthStateChanged(user => {
				if (user) {
					// User is signed in, see docs for a list of available properties
					// https://firebase.google.com/docs/reference/js/auth.user

					if (!user.email.match(emailVaildRegExp)) {
						alert('DB ê´€ë ¨ êµ¬ê¸€ ë©”ì¼ë¡œë§Œ ë¡œê·¸ì¸ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
						signOut();
					} else {
						signIn(user);
					}
					//writeDeptStat('1000', 'OK', user.email, user.displayName, uid, 'TEST OK!!');
					// ...
				} else {
					signOut();
				}
			});

			// Initialize Firebase Cloud Messaging and get a reference to the service
			//const messaging = firebase.messaging();

			// Add the public key generated from the console here.
			//firebase.messaging().getToken(messaging, {
			//	vapidKey: "BFmunl_Ohkyt21n-TC9fTxtsLQtwhZbjBAkevk6rTkS_Oo5Q6ek7U7xJH9iW8QNthQ3toHm1bF8A4nqTvs9Ty_A"
			//});
			// Get registration token. Initially this makes a network call, once retrieved
			// subsequent calls to getToken will return from cache.

			// firebase.messaging().getToken({
			// 	vapidKey: 'BFmunl_Ohkyt21n-TC9fTxtsLQtwhZbjBAkevk6rTkS_Oo5Q6ek7U7xJH9iW8QNthQ3toHm1bF8A4nqTvs9Ty_A'
			// }).then((currentToken) => {
			// 	if (currentToken) {
			// 		registerToken(currentToken);
			// 	} else {
			// 		// Show permission request UI
			// 		console.log('No registration token available. Request permission to generate one.');
			// 		// ...
			// 	}
			// }).catch((err) => {
			// 	console.log('An error occurred while retrieving token. ', err);
			// 	// ...
			// });

			// Handle incoming messages. Called when:
			// - a message is received while the app has focus
			// - the user clicks on an app notification created by a service worker
			//   `messaging.onBackgroundMessage` handler.
			firebase.messaging().onMessage((payload) => {
				console.log('Message received. ', payload);
				alert(payload.notification.title + "\n" + payload.notification.body);
			});

			//firebase.database().ref('/path/to/ref').on('value', snapshot => { });
			//const database = firebase.database();
			//const dbRef = firebase.database().ref("stats").orderByChild('time');
			const dbRef = firebase.database().ref("stats").limitToLast(50);
			/*
				  dbRef.get().then((snapshot) => {
					if (snapshot.exists()) {
					  console.log(snapshot.val());
					} else {
					  console.log("No data available");
					}
				  }).catch((error) => {
					console.error(error);
				  });
			*/
			dbRef.on('child_added', (data) => {
				//console.log(data.val());
				addStat(data.val());
			});
			// firebase.firestore().doc('/foo/bar').get().then(() => { });
			// firebase.functions().httpsCallable('yourFunction')().then(() => { });
			// firebase.messaging().requestPermission().then(() => { });
			// firebase.storage().ref('/path/to/ref').getDownloadURL().then(() => { });
			firebase.analytics(); // call to activate
			// firebase.analytics().logEvent('tutorial_completed');
			// firebase.performance(); // call to activate
			//
			// // ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥

			try {
				let app = firebase.app();
				let features = [
					'auth',
					'database',
					'firestore',
					'functions',
					'messaging',
					'storage',
					'analytics',
					'remoteConfig',
					'performance',
				].filter(feature => typeof app[feature] === 'function');
				//loadEl.textContent = `Firebase SDK loaded with ${features.join(', ')}.`;
			} catch (e) {
				console.error(e);
				//loadEl.textContent = 'Error loading the Firebase SDK, check the console.';
			}

			document.getElementById('logout').addEventListener('click', () => {
				signOut();
			});

			//document.getElementById('setpush').addEventListener('click', () => {
				//requestPermission();
				//openModal();
			//});

			document.getElementById('submit').addEventListener('click', () => {
				//validation
				const stat = document.getElementById('stat').value;
				if (!stat || stat == 'none') {
					alert('ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
					return;
				}
				const dept = document.getElementById('dept').value;
				if (!(dept && dept.match(/[1-5]000/))) {
					alert('ëŒ€ìƒ ë¶€ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
					return;
				}
				writeDeptStat(dept,
					stat,
					document.getElementById('email').value,
					document.getElementById('name').value,
					document.getElementById('uid').value,
					document.getElementById('msg').value,
					document.getElementById('subject').value,
					document.getElementById('isPush').checked
				);
				closeAddStat();
			});

			document.getElementById('n1000').addEventListener('click', () => {
				filterList('1000');
			});

			document.getElementById('n2000').addEventListener('click', () => {
				filterList('2000');
			});

			document.getElementById('n3000').addEventListener('click', () => {
				filterList('3000');
			});

			document.getElementById('n4000').addEventListener('click', () => {
				filterList('4000');
			});

			document.getElementById('n5000').addEventListener('click', () => {
				filterList('5000');
			});

			document.getElementById('title').addEventListener('click', () => {
				filterList('');
			});

		});
			// ì•Œë¦¼ ë“±ë¡ ë¡œì§
			function registerNotification(token) {
				const uid = document.getElementById('uid').value;
				const departments = document.querySelectorAll('input[name="department"]');

				// `token`ì´ ì˜¬ë°”ë¥´ê²Œ ì „ë‹¬ë˜ì—ˆëŠ”ì§€ í™•ì¸
				if (!token || typeof token === 'undefined') {
					console.error('Token is undefined or invalid:', token);
					alert('í† í°ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
					return;
				}

				const iphone = navigator.userAgent.toLowerCase().indexOf('iphone') >= 0 //true : iPhone

				let anyChecked = false; // ì•Œë¦¼ ë“±ë¡ ì—¬ë¶€ í™•ì¸ ë³€ìˆ˜

				// ëª¨ë“  ë¶€ì„œì— ëŒ€í•´ í† í° ì—…ë°ì´íŠ¸ ë˜ëŠ” null ì„¤ì •
				departments.forEach(dept => {
					const deptId = dept.value;
					const isChecked = dept.checked; // ì²´í¬ ì—¬ë¶€ í™•ì¸
					const path = `noti/${deptId}/${uid}`;


					// `uid`ì™€ `deptId`ê°€ ìœ íš¨í•œì§€ í™•ì¸
					if (!uid || typeof uid === 'undefined' || !deptId || typeof deptId === 'undefined') {
						console.error('Invalid UID or Department ID:', { uid, deptId });
						return;
					}

					// if (isChecked) {
					// 	anyChecked = true; // í•˜ë‚˜ë¼ë„ ì²´í¬ë˜ë©´ trueë¡œ ë³€ê²½
					// }

					// ì„ íƒëœ ë¶€ì„œì—ëŠ” í† í° ì €ì¥, ì„ íƒë˜ì§€ ì•Šì€ ë¶€ì„œëŠ” nullë¡œ ì„¤ì •
					//const tokenValue = isChecked ? token : null;
					firebase.database().ref(path).update({ token: isChecked ? token : null, iphone: isChecked ? iphone : null }) // update ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ token ê°’ë§Œ ìˆ˜ì •
						//.then(() => {
						//	console.log(`${deptId}ì— ëŒ€í•œ í† í°ì´ ${tokenValue ? 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'nullë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.'}`);
						//})
						.catch(err => {
							console.error(`í† í° ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${err}`);
						});
				});

				// // ë§Œì•½ ì•„ë¬´ ë¶€ì„œë„ ì²´í¬ë˜ì§€ ì•Šì•˜ë‹¤ë©´ pushì—ì„œ uid ë°ì´í„° ì‚­ì œ
				// if (!anyChecked) {
				// 	firebase.database().ref(`push/${uid}`).remove()
				// 	.then(() => {
				// 		console.log('ì•Œë¦¼ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ pushì—ì„œ uid ë°ì´í„°ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.');
				// 	})
				// 	.catch(err => {
				// 		console.error('push ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ', err);
				// 	});
				// }

				closeModal();
			}

		function registerToken(currentToken){
			if (currentToken) {
				console.log('currentToken:', currentToken);
				// Send the token to your server and update the UI if necessary
				const time = Date.now();
				const uid = document.getElementById('uid').value;
				const name = document.getElementById('name').value;
				if(uid){
					firebase.database().ref(`push/${uid}`).set({
						time: time,
						token: currentToken,
						name: name
					}).then((currentToken) => {
						alert('ì‚¬ìš©ì ë“±ë¡ì´ ë˜ì—ˆìŠµë‹ˆë‹¤: ' + name);
					}).catch((err) => {
						console.log('An error occurred while add push list. ', err);
						// ...
					});
						registerNotification(currentToken);
				}else{
					//console.error('uid:', uid);
					needsRegisterWithToken = currentToken;
				}
			} else {
				// Show permission request UI
				console.log('No registration token available. Request permission to generate one.');
				// ...
			}
		}

		function requestPermission() {
			console.log('Requesting permission...');
			if (!("Notification" in window)) {
				alert('iOSì˜ ê²½ìš°, í™ˆ í™”ë©´ì— ì¶”ê°€ í›„ ì•Œë¦¼ ë“±ë¡ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
				return;
			}
			Notification.requestPermission().then((permission) => {
				if (permission === 'granted') {
					console.log('Notification permission granted!');

					// Get registration token. Initially this makes a network call, once retrieved
					// subsequent calls to getToken will return from cache.
					firebase.messaging().getToken({
						vapidKey: 'BKxvnPi49pfuBWPqxBP1bfOuhtBz_ghjgEde-Tq3IqgOYm1s0t5eaB96bHIAfWKRJMnuOdghdB0i6DhYK_T6shI'
					}).then((currentToken) => {
						registerToken(currentToken);
					}).catch((err) => {
						console.log('An error occurred while retrieving token. ', err);
						// ...
					});
				} else {
					console.error('Notification permission not granted.');
					alert('Notification permission:'+permission);
				}
			}).catch((err) => {
				console.log('An error occurred while request permission. ', err);
				alert('An error occurred while request permission. ' + err);
			});
		}

		function filterList(dept) {
			if (!dept || dept == '') {
				document.querySelectorAll("main li").forEach(li => {
					li.style.display = '';
				});
				return;
			}
			//console.log(document.querySelectorAll("main li"));
			//console.log(document.getElementsByName(dept));
			document.querySelectorAll("main li").forEach(li => {
				li.style.display = 'none';
			});
			document.getElementsByName(dept).forEach(li => {
				li.style.display = '';
			});
		}

		function signIn(user) {
			document.getElementById('uid').value = user.uid;
			document.getElementById('email').value = user.email;
			document.getElementById('name').value = user.displayName;
			//console.log(user.displayName);
			const userStrArr = user.displayName.split(/[ \/]+/);
			//console.log(userStrArr);
			document.getElementById('displayName').innerText = userStrArr[0];
			document.getElementById('displayPos').innerText = userStrArr[1];
			document.getElementById('displayDept').innerText = userStrArr[2];
			//document.getElementById('user').innerText = `${user.displayName} (${user.email})`;
			//document.getElementById('user-email').innerText = `Email: ${user.email}`;
			//document.getElementById('user-details').style.display = 'block';
			//document.getElementById('login').style.display = 'none';
			//document.getElementById('logout').style.display = 'block';
			//document.getElementById('stats').style.display = 'block';
			//document.getElementById('add-stat').style.display = 'block';

			//const uid = user.uid;
			//console.log('uid:', uid); // ë¡œê·¸ë¡œ uid ê°’ í™•ì¸
			//firebase.database().ref(`push/${uid}`).get().then(snapshot => {
			//	if (!snapshot.exists()) {
			//		// uid ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€ì™€ ëª¨ë‹¬ í‘œì‹œ
			//		alert('ì•Œë¦¼ì´ ë“±ë¡ëœ ë¶€ì„œê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ê¸€ì´ ì˜¬ë¼ì˜¤ë©´ ì•Œë¦¼ì„ ë°›ê¸° ìœ„í•´ ë“±ë¡ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.');
			//		openModal(); // ì•Œë¦¼ ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
			//	}
			//}).catch(err => {
			//	console.error('push ë°ì´í„° í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', err);
			//});

			//if(needsRegisterWithToken){
			//	registerToken(needsRegisterWithToken);
			//}
			pushDeptsCheck();
		}

		function signOut() {
			firebase.auth().signOut().then(() => {
				window.location.href = 'index.html';
			}).catch((error) => {
				console.error(error);
			});
		}

		function addStat(data) {
			//console.log(data['time']);
			let imgName = 'green';
			if (data['stat'] == 'Warn') {
				imgName = 'yellow';
			} else if (data['stat'] == 'Fail') {
				imgName = 'red';
			} else if (data['stat'] == 'yellow') {
				imgName = 'yellow';
			} else if (data['stat'] == 'red') {
				imgName = 'red';
			} else if (data['stat'] == 'gray') {
				imgName = 'gray';
			}
			let imgFullPathAndName = "./images/img_stat_" + imgName + ".svg";
			//document.getElementById(data['dept']).style.backgroundImage = `url('${imgName}')`;
			document.getElementById(data['dept']).setAttribute('data', imgFullPathAndName);

			let deptName = '';
			if (data['dept'] == '1000') {
				deptName = 'ì†ë³´ì •ë³´ì„œë¹„ìŠ¤íŒ€';
			} else if (data['dept'] == '2000') {
				deptName = 'ìƒëª…ì •ë³´ì„œë¹„ìŠ¤íŒ€';
			} else if (data['dept'] == '3000') {
				deptName = 'ê¸ˆìœµì •ë³´ì„œë¹„ìŠ¤íŒ€';
			} else if (data['dept'] == '4000') {
				deptName = 'í•˜ì´í…ì •ë³´ì„œë¹„ìŠ¤íŒ€';
			} else if (data['dept'] == '5000') {
				deptName = 'ì €ì¶•ì •ë³´ì„œë¹„ìŠ¤íŒ€';
			}
			const dateStr = dateFormat(new Date(data['time']));
			//const sub = data['subject']?.replaceAll('\n', ' ');
			let sub = '';
			if (data['subject']) {
				sub = ' - ' + data['subject'].replaceAll('\n', ' ');
			}
			const msg = data['message'].replaceAll('\n', '<br/>');

			let html = `<li id="${data['time']}" name="${data['dept']}">\r\n`;
					html += `<div class="stat"><i class="${imgName}"></i> ${deptName} <span class="sub-msg">${sub}</span></div>\r\n`; // subë¥¼ spanìœ¼ë¡œ ê°ì‹¸ê³  í´ë˜ìŠ¤ ì¶”ê°€
					html += `<div class="msg">${msg}</div>\r\n`;
					html += `<div class="user"><span>${data['name']}</span></div>\r\n`;
					html += `<div class="date">${dateStr}</div>\r\n`;
					html += `</li>\r\n`;

			document.getElementById('stats').innerHTML = html + document.getElementById('stats').innerHTML;
		}

			function writeDeptStat(dept, stat, email, name, uid, message, subject, isPush) {
			const time = Date.now();
			firebase.database().ref(`stats/${time}`).set({
				time: time,
				dept: dept,
				stat: stat,
				email: email,
				name: name,
				uid: uid,
				message: message,
				subject: subject,
				isPush: isPush
			});
			alert('ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
		}

		function dateFormat(date) {
			return date.getFullYear() +
				'-' + ((date.getMonth() + 1) <= 9 ? "0" + (date.getMonth() + 1) : (date.getMonth() + 1)) +
				'-' + ((date.getDate()) <= 9 ? "0" + (date.getDate()) : (date.getDate())) +
				' ' + ((date.getHours()) <= 9 ? "0" + (date.getHours()) : (date.getHours())) +
				':' + ((date.getMinutes()) <= 9 ? "0" + (date.getMinutes()) : (date.getMinutes())) +
				':' + ((date.getSeconds()) <= 9 ? "0" + (date.getSeconds()) : (date.getSeconds()))
				;
		}

	</script>


</body>

</html>